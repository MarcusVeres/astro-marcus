---
import { getCollection } from "astro:content";
import { getResourceColor } from "../utils/resourceColors";
import ResourceIcon from './atoms/ResourceIcon.astro';
import ButtonAura from './atoms/ButtonAura.astro';

// Get featured resources only
const allResources = await getCollection("resources");
const featuredResources = allResources
  .filter(resource => resource.data.featured === true)
  .sort((a, b) => {
    // Sort by order if available
    if (a.data.order !== undefined && b.data.order !== undefined) {
      return a.data.order - b.data.order;
    }
    if (a.data.order !== undefined) return -1;
    if (b.data.order !== undefined) return 1;

    // Fallback to date
    const dateA = a.data.pubDate || new Date(0);
    const dateB = b.data.pubDate || new Date(0);
    return dateB.getTime() - dateA.getTime();
  });
---

<style>
  /* Hide scrollbar but allow scrolling */
  .scrollbar-hide {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;  /* Chrome, Safari, Opera */
  }

  /* Truncate description text */
  .description-truncate {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Show full description on hover (desktop only) */
  @media (min-width: 768px) {
    .resource-card:hover .description-truncate {
      -webkit-line-clamp: unset;
      overflow: visible;
    }
  }
</style>

<div id="resources" class="py-12 bg-gray-900 sm:pt-20">
  <div class="px-6 mx-auto max-w-7xl lg:px-8">
    <div class="max-w-2xl mx-auto text-center">
      <h2 class="text-4xl font-semibold tracking-tight text-white text-balance sm:text-5xl">Free tools to get you started</h2>
      <p class="mt-2 text-gray-400 text-lg/8">Because good advice shouldn't require a credit card.</p>
    </div>

    <!-- Horizontal Scrollable Container -->
    <div class="relative mt-16 sm:mt-20">
      <!-- Scroll container -->
      <div class="flex gap-4 pb-4 overflow-x-auto scrollbar-hide snap-x snap-mandatory md:gap-6">
        {featuredResources.map((resource, index) => {
          const color = getResourceColor(resource.data.tags, resource.data.color, index);

          // Use surTitle/mainTitle/subTitle if available, otherwise fallback to full title
          const displaySurTitle = resource.data.surTitle;
          const displayMainTitle = resource.data.mainTitle || resource.data.title;
          const displaySubTitle = resource.data.subTitle;

          // Determine link
          const resourceUrl = resource.data.standaloneUrl || `/resources/${resource.id}`;

          // Map color to full class names
          const colorClasses = {
            'blue-500': 'bg-blue-500/30 hover:bg-blue-500/50',
            'pink-500': 'bg-pink-500/30 hover:bg-pink-500/50',
            'green-500': 'bg-green-500/30 hover:bg-green-500/50',
            'purple-600': 'bg-purple-600/30 hover:bg-purple-600/50',
            'yellow-500': 'bg-yellow-500/30 hover:bg-yellow-500/50',
            'red-500': 'bg-red-500/30 hover:bg-red-500/50',
          };
          const bgColorClass = colorClasses[color] || 'bg-cyan-500/30 hover:bg-cyan-500/50';

          return (
            <a
              href={resourceUrl}
              class={`resource-card flex-shrink-0 w-full sm:w-80 md:w-96 flex flex-col gap-4 p-6 rounded-2xl transition-all duration-300 ${bgColorClass} snap-center snap-always`}
            >
              {/* Icon */}
              <div class="flex items-center justify-center w-16 h-16 mx-auto">
                <ResourceIcon icon={resource.data.icon} />
              </div>

              {/* Title */}
              <h3 class="text-2xl font-bold tracking-tight text-center text-white md:text-3xl">
                {displaySurTitle && (
                  <span class="block text-lg font-semibold md:text-xl">{displaySurTitle}</span>
                )}
                <span class="block">{displayMainTitle}</span>
                {displaySubTitle && (
                  <span class="block text-lg font-semibold md:text-xl">{displaySubTitle}</span>
                )}
              </h3>

              {/* Description - truncated by default, full on hover */}
              <p class="text-sm text-center text-gray-300 description-truncate md:text-base">
                {resource.data.description}
              </p>
            </a>
          );
        })}
      </div>
    </div>

    <!-- View All Button -->
    <div class="flex justify-center mt-10">
      <ButtonAura label="View All Resources" link="/resources" />
    </div>
  </div>
</div>
