---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogPost from '../../layouts/BlogPost.astro';
import { Image } from 'astro:assets';

import ButtonAura from '../../components/atoms/ButtonAura.astro'

import { getCollection } from "astro:content";

export async function getStaticPaths() {

    // Get blog posts, resources, and portfolio
    const allPosts = await getCollection("blog");
    const allResources = await getCollection("resources");
    const allPortfolio = await getCollection("portfolio");

    // Get a list of all unique tags from all three collections
    const allTags = [
        ...allPosts.map((post) => post.data.tags).flat(),
        ...allResources.map((resource) => resource.data.tags).flat(),
        ...allPortfolio.map((item) => item.data.tags || []).flat()
    ];
    const uniqueTags = [...new Set(allTags)];

    // Create pages for each tag, with filtered posts, resources, and portfolio
    return uniqueTags.map((tag) => {
        const filteredPosts = allPosts.filter((post) =>
            post.data.tags.includes(tag)
        );
        const filteredResources = allResources.filter((resource) =>
            resource.data.tags.includes(tag)
        );
        const filteredPortfolio = allPortfolio.filter((item) =>
            item.data.tags && item.data.tags.includes(tag)
        );
        return {
            params: { tag },
            props: {
                posts: filteredPosts,
                resources: filteredResources,
                portfolio: filteredPortfolio
            },
        };
    });
}

const { tag } = Astro.params;
const { posts, resources, portfolio } = Astro.props;

---
<BaseLayout pageTitle={tag}>

    <!-- <div class="py-24 bg-gray-900 sm:py-32">
    <div class="px-6 mx-auto max-w-7xl lg:px-8">

        <div class="max-w-2xl mx-auto lg:max-w-4xl">

            <h2 class="text-4xl font-semibold tracking-tight text-white text-pretty sm:text-5xl">More about: <span class="underline">{ tag }</span></h2>
            <p class="mt-2 text-gray-400 text-lg/8">Posts tagged with: <span class="underline">{ tag }</span></p>

            <div class="mt-16 space-y-20 lg:mt-20">
            { posts.map((post) => (

                <article class="relative flex flex-col gap-8 isolate lg:flex-row">
                <div class="relative aspect-video sm:aspect-2/1 lg:aspect-square lg:w-64 lg:shrink-0">
                    <img src={post.data.image.url} alt={post.data.image.alt} class="absolute inset-0 object-cover bg-gray-800 size-full rounded-2xl" />
                    <div class="absolute inset-0 rounded-2xl inset-ring inset-ring-white/10"></div>
                </div>
                <div>
                    <div class="flex items-center text-xs gap-x-4">
                        <time datetime="2020-03-16" class="text-gray-400">{ post.data.pubDate }</time>
                    </div>
                    <div class="relative max-w-xl group">
                    <h3 class="mt-3 text-2xl font-semibold text-white group-hover:text-gray-300">
                        <a href={`/posts/${post.id}/`}>
                            <span class="absolute inset-0"></span>
                            { post.data.title }
                        </a>
                    </h3>
                    <p class="mt-3 text-gray-400 text-sm/6">
                        { post.data.description }
                    </p>
                    </div>
                    <div class="flex gap-2 pt-6 mt-6 text-xs border-t border-white/10">
                        { post.data.tags.map( ( tag ) => (
                            <a href={`/tags/${tag}`} class="relative z-10 rounded-full bg-gray-800/60 px-3 py-1.5 font-semibold text-gray-300 hover:bg-gray-800">
                                { tag }
                            </a>
                        ) ) }
                    </div>
                </div>
                </article>

            ) ) }
            </div>
        </div>

    </div>
    </div> -->

    <div class="py-24 bg-gray-900 sm:py-32">
        <div class="px-6 mx-auto max-w-7xl lg:px-8">
            <div class="max-w-2xl mx-auto">
                <h2 class="text-4xl font-semibold tracking-tight text-white text-pretty sm:text-5xl">
                    More about: <span class="underline">{ tag }</span>
                </h2>
                <p class="mt-2 text-gray-300 text-lg/8">
                    Posts tagged with: <span class="underline">{ tag }</span>
                </p>
                <div class="pt-10 mt-10 space-y-16 border-t border-gray-700 sm:mt-16 sm:pt-16">

                    { posts.map((post) => (

                        <article class="relative flex flex-col gap-8 isolate lg:flex-row">
                            <a href={`/posts/${post.id}/`}>
                                <div class="relative aspect-video sm:aspect-2/1 lg:aspect-square lg:w-64 lg:shrink-0">
                                    <img src={post.data.image.url} alt={post.data.image.alt} class="absolute inset-0 object-cover bg-gray-800 size-full rounded-2xl" />
                                    <div class="absolute inset-0 rounded-2xl inset-ring inset-ring-white/10"></div>
                                </div>
                            </a>
                            <div>
                                <div class="flex items-center mt-3 text-xs gap-x-4">
                                    <time datetime="2020-03-16" class="text-gray-400">{ post.data.pubDate.toDateString() }</time>
                                </div>
                                <div class="relative max-w-xl group">
                                <h3 class="mt-3 text-2xl font-semibold text-white group-hover:text-gray-300">
                                    <a href={`/posts/${post.id}/`}>
                                        <span class="absolute inset-0"></span>
                                        { post.data.title }
                                    </a>
                                </h3>
                                <p class="mt-3 text-gray-400 text-sm/6">
                                    { post.data.description }
                                </p>
                                </div>
                                <div class="flex gap-2 pt-6 mt-6 text-xs border-t border-white/10">
                                    { post.data.tags.map( ( tag ) => (
                                        <a href={`/tags/${tag}`} class="relative z-10 rounded-full bg-gray-800/60 px-3 py-1.5 font-semibold text-gray-300 hover:bg-gray-800">
                                            { tag }
                                        </a>
                                    ) ) }
                                </div>
                            </div>
                        </article>

                    ) ) }

                </div>
            </div>
        </div>

        <!-- Resources Section -->
        {resources.length > 0 && (
            <div class="px-6 mx-auto mt-20 max-w-7xl lg:px-8">
                <h2 class="text-3xl font-semibold tracking-tight text-white text-pretty sm:text-4xl">
                    Resources tagged with: <span class="underline">{ tag }</span>
                </h2>
                <div class="pt-10 mt-10 space-y-8 border-t border-gray-700">
                    {resources.map((resource) => (
                        <article class="flex flex-col gap-4 lg:flex-row lg:items-center">
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold text-white group-hover:text-gray-300">
                                    <a href={`/resources/${resource.id}`}>
                                        {resource.data.title}
                                    </a>
                                </h3>
                                <p class="mt-2 text-gray-400 text-sm/6">
                                    {resource.data.description}
                                </p>
                                <div class="flex gap-2 mt-4 text-xs">
                                    {resource.data.tags.map((resourceTag) => (
                                        <a href={`/tags/${resourceTag}`} class="px-3 py-1.5 font-semibold text-gray-300 rounded-full bg-gray-800/60 hover:bg-gray-800">
                                            {resourceTag}
                                        </a>
                                    ))}
                                </div>
                            </div>
                        </article>
                    ))}
                </div>
            </div>
        )}

        <!-- Portfolio Section -->
        {portfolio.length > 0 && (
            <div class="px-6 mx-auto mt-20 max-w-7xl lg:px-8">
                <h2 class="text-3xl font-semibold tracking-tight text-white text-pretty sm:text-4xl">
                    Portfolio tagged with: <span class="underline">{ tag }</span>
                </h2>
                <div class="pt-10 mt-10 border-t border-gray-700">
                    <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4">
                        {portfolio.map((item) => (
                            <article class="relative group">
                                <a href={`/portfolio/${item.id}`} class="block overflow-hidden rounded-lg aspect-square">
                                    <Image
                                        src={item.data.thumbnail || item.data.image}
                                        alt={item.data.title}
                                        class="object-cover w-full h-full transition-transform duration-300 group-hover:scale-110"
                                        widths={[300, 400, 600]}
                                        sizes="(max-width: 640px) 50vw, (max-width: 1024px) 33vw, 25vw"
                                        loading="lazy"
                                    />
                                    <div class="absolute inset-0 transition-opacity bg-black/60 group-hover:bg-black/40"></div>
                                    <h3 class="absolute inset-0 flex items-center justify-center p-4 text-sm font-semibold text-center text-white">
                                        {item.data.title}
                                    </h3>
                                </a>
                                <div class="flex gap-2 mt-3 text-xs">
                                    {item.data.tags && item.data.tags.map((portfolioTag) => (
                                        <a href={`/tags/${portfolioTag}`} class="px-2 py-1 font-semibold text-gray-300 rounded-full bg-gray-800/60 hover:bg-gray-800">
                                            {portfolioTag}
                                        </a>
                                    ))}
                                </div>
                            </article>
                        ))}
                    </div>
                </div>
            </div>
        )}

        <div class="flex flex-wrap items-center justify-center gap-4 pt-44">
            <ButtonAura link="/tags" label="Back to Tags Page" />
            <ButtonAura link="/blog" label="Back to Blog" />
            {resources.length > 0 && (
                <ButtonAura link="/resources" label="All Resources" />
            )}
            {portfolio.length > 0 && (
                <ButtonAura link="/portfolio" label="All Portfolio" />
            )}
        </div>
    </div>


</BaseLayout>
